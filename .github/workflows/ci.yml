name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5'
    
    - name: Run Go tests with coverage
      run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.out
        flags: unittests
    
    - name: Build server
      run: go build -o redis-server ./cmd/server
    
    - name: Start server
      run: ./redis-server &
      
    - name: Wait for server
      run: sleep 2
    
    - name: Install redis-tools
      run: sudo apt-get update && sudo apt-get install -y redis-tools
    
    - name: Run redis-benchmark
      run: redis-benchmark -t SET,GET,DEL -n 10000 -q
    
    - name: Stop server
      run: pkill redis-server || true
